// Copyright 2016 The go-ethereum Authors
// This file is part of the go-ethereum library.
//
// The go-ethereum library is free software: you can redistribute it and/or modify
// it under the terms of the GNU Lesser General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// The go-ethereum library is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
// GNU Lesser General Public License for more details.
//
// You should have received a copy of the GNU Lesser General Public License
// along with the go-ethereum library. If not, see <http://www.gnu.org/licenses/>.

package misc

import (
	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/core/state"
)

var (
	// L2ConfigProxy contract info
	L2ConfigProxy                   = common.HexToAddress("0x4200000000000000000000000000000000000801")
	L2ConfigProxyCode               = common.Hex2Bytes("0x60806040526004361061005e5760003560e01c80635c60da1b116100435780635c60da1b146100be5780638f283970146100f8578063f851a440146101185761006d565b80633659cfe6146100755780634f1ef286146100955761006d565b3661006d5761006b61012d565b005b61006b61012d565b34801561008157600080fd5b5061006b6100903660046106d9565b610224565b6100a86100a33660046106f4565b610296565b6040516100b59190610777565b60405180910390f35b3480156100ca57600080fd5b506100d3610419565b60405173ffffffffffffffffffffffffffffffffffffffff90911681526020016100b5565b34801561010457600080fd5b5061006b6101133660046106d9565b6104b0565b34801561012457600080fd5b506100d3610517565b60006101577f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc5490565b905073ffffffffffffffffffffffffffffffffffffffff8116610201576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152602560248201527f50726f78793a20696d706c656d656e746174696f6e206e6f7420696e6974696160448201527f6c697a656400000000000000000000000000000000000000000000000000000060648201526084015b60405180910390fd5b3660008037600080366000845af43d6000803e8061021e573d6000fd5b503d6000f35b7fb53127684a568b3173ae13b9f8a6016e243e63b6e8ee1178d6a717850b5d61035473ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16148061027d575033155b1561028e5761028b816105a3565b50565b61028b61012d565b60606102c07fb53127684a568b3173ae13b9f8a6016e243e63b6e8ee1178d6a717850b5d61035490565b73ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614806102f7575033155b1561040a57610305846105a3565b6000808573ffffffffffffffffffffffffffffffffffffffff16858560405161032f9291906107ea565b600060405180830381855af49150503d806000811461036a576040519150601f19603f3d011682016040523d82523d6000602084013e61036f565b606091505b509150915081610401576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152603960248201527f50726f78793a2064656c656761746563616c6c20746f206e657720696d706c6560448201527f6d656e746174696f6e20636f6e7472616374206661696c65640000000000000060648201526084016101f8565b91506104129050565b61041261012d565b9392505050565b60006104437fb53127684a568b3173ae13b9f8a6016e243e63b6e8ee1178d6a717850b5d61035490565b73ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16148061047a575033155b156104a557507f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc5490565b6104ad61012d565b90565b7fb53127684a568b3173ae13b9f8a6016e243e63b6e8ee1178d6a717850b5d61035473ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161480610509575033155b1561028e5761028b8161060b565b60006105417fb53127684a568b3173ae13b9f8a6016e243e63b6e8ee1178d6a717850b5d61035490565b73ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161480610578575033155b156104a557507fb53127684a568b3173ae13b9f8a6016e243e63b6e8ee1178d6a717850b5d61035490565b7f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc81905560405173ffffffffffffffffffffffffffffffffffffffff8216907fbc7cd75a20ee27fd9adebab32041f755214dbc6bffa90cc0225b39da2e5c2d3b90600090a250565b60006106357fb53127684a568b3173ae13b9f8a6016e243e63b6e8ee1178d6a717850b5d61035490565b7fb53127684a568b3173ae13b9f8a6016e243e63b6e8ee1178d6a717850b5d61038390556040805173ffffffffffffffffffffffffffffffffffffffff8084168252851660208201529192507f7e644d79422f17c01e4894b5f4f588d331ebfa28653d42ae832dc59e38c9798f910160405180910390a15050565b803573ffffffffffffffffffffffffffffffffffffffff811681146106d457600080fd5b919050565b6000602082840312156106eb57600080fd5b610412826106b0565b60008060006040848603121561070957600080fd5b610712846106b0565b9250602084013567ffffffffffffffff8082111561072f57600080fd5b818601915086601f83011261074357600080fd5b81358181111561075257600080fd5b87602082850101111561076457600080fd5b6020830194508093505050509250925092565b600060208083528351808285015260005b818110156107a457858101830151858201604001528201610788565b818111156107b6576000604083870101525b50601f017fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe016929092016040019392505050565b818382376000910190815291905056fea164736f6c634300080f000a")
	L2ConfigProxyAdminKey           = common.HexToHash("0xb53127684a568b3173ae13b9f8a6016e243e63b6e8ee1178d6a717850b5d6103")
	L2ConfigProxyAdminValue         = common.HexToHash("0x0000000000000000000000004200000000000000000000000000000000000018")
	L2ConfigProxyImplKey            = common.HexToHash("0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc")
	L2ConfigProxyImplValue          = common.HexToHash("0x000000000000000000000000c0d3c0d3c0d3c0d3c0d3c0d3c0d3c0d3c0d30801")
	L2ConfigProxyOwnerKey           = common.HexToHash("0x0000000000000000000000000000000000000000000000000000000000000033")
	L2ConfigProxyOwnerValue         = common.HexToHash("0x00000000000000000000000047d406f5faa74f8600870f8c0053d20aeb1f0d36") // system config mainnet owner
	L2ConfigProxyL1MinGasPriceKey   = common.HexToHash("0x0000000000000000000000000000000000000000000000000000000000000065")
	L2ConfigProxyL1MinGasPriceValue = common.HexToHash("0x00000000000000000000000000000000000000000000000000000000B2D05E00") // 3 gwei

	// L2Config contract info
	L2Config                   = common.HexToAddress("0xc0d3c0d3c0d3c0d3c0d3c0d3c0d3c0d3c0d30801")
	L2ConfigCode               = common.Hex2Bytes("0x608060405234801561001057600080fd5b50600436106100885760003560e01c80638da5cb5b1161005b5780638da5cb5b146100db578063ad7df53514610103578063f2fde38b14610116578063ffa1ad741461012957600080fd5b80631798de811461008d57806339dc823f146100a257806354fd4d50146100be578063715018a6146100d3575b600080fd5b6100a061009b3660046108b6565b610131565b005b6100ab60655481565b6040519081526020015b60405180910390f35b6100c66102e1565b6040516100b59190610963565b6100a0610384565b60335460405173ffffffffffffffffffffffffffffffffffffffff90911681526020016100b5565b6100a061011136600461097d565b610398565b6100a0610124366004610998565b61042e565b6100ab600081565b600054610100900460ff16158080156101515750600054600160ff909116105b8061016b5750303b15801561016b575060005460ff166001145b6101fc576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152602e60248201527f496e697469616c697a61626c653a20636f6e747261637420697320616c72656160448201527f647920696e697469616c697a656400000000000000000000000000000000000060648201526084015b60405180910390fd5b600080547fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff00166001179055801561025a57600080547fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff00ff166101001790555b610262610501565b61026b8361042e565b67ffffffffffffffff821660655580156102dc57600080547fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff00ff169055604051600181527f7f26b83ff96e1f2b6a682f133852f6798a09c465da95921460cefb38474024989060200160405180910390a15b505050565b606061030c7f00000000000000000000000000000000000000000000000000000000000000006105a0565b6103357f00000000000000000000000000000000000000000000000000000000000000006105a0565b61035e7f00000000000000000000000000000000000000000000000000000000000000006105a0565b604051602001610370939291906109b3565b604051602081830303815290604052905090565b61038c6106dd565b610396600061075e565b565b6103a06106dd565b67ffffffffffffffff8116606581905560408051602081019290925260009101604080517fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe081840301815291905290506000807f1d2b0bda21d56b8bd12d4f94ebacffdfb35f5e226f84b461103bb8beab6353be836040516104229190610963565b60405180910390a35050565b6104366106dd565b73ffffffffffffffffffffffffffffffffffffffff81166104d9576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152602660248201527f4f776e61626c653a206e6577206f776e657220697320746865207a65726f206160448201527f646472657373000000000000000000000000000000000000000000000000000060648201526084016101f3565b6104e28161075e565b50565b73ffffffffffffffffffffffffffffffffffffffff163b151590565b600054610100900460ff16610598576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152602b60248201527f496e697469616c697a61626c653a20636f6e7472616374206973206e6f74206960448201527f6e697469616c697a696e6700000000000000000000000000000000000000000060648201526084016101f3565b6103966107d5565b6060816000036105e357505060408051808201909152600181527f3000000000000000000000000000000000000000000000000000000000000000602082015290565b8160005b811561060d57806105f781610a58565b91506106069050600a83610abf565b91506105e7565b60008167ffffffffffffffff81111561062857610628610ad3565b6040519080825280601f01601f191660200182016040528015610652576020820181803683370190505b5090505b84156106d557610667600183610b02565b9150610674600a86610b19565b61067f906030610b2d565b60f81b81838151811061069457610694610b45565b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a9053506106ce600a86610abf565b9450610656565b949350505050565b60335473ffffffffffffffffffffffffffffffffffffffff163314610396576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820181905260248201527f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e657260448201526064016101f3565b6033805473ffffffffffffffffffffffffffffffffffffffff8381167fffffffffffffffffffffffff0000000000000000000000000000000000000000831681179093556040519116919082907f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e090600090a35050565b600054610100900460ff1661086c576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152602b60248201527f496e697469616c697a61626c653a20636f6e7472616374206973206e6f74206960448201527f6e697469616c697a696e6700000000000000000000000000000000000000000060648201526084016101f3565b6103963361075e565b803573ffffffffffffffffffffffffffffffffffffffff8116811461089957600080fd5b919050565b803567ffffffffffffffff8116811461089957600080fd5b600080604083850312156108c957600080fd5b6108d283610875565b91506108e06020840161089e565b90509250929050565b60005b838110156109045781810151838201526020016108ec565b83811115610913576000848401525b50505050565b600081518084526109318160208601602086016108e9565b601f017fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0169290920160200192915050565b6020815260006109766020830184610919565b9392505050565b60006020828403121561098f57600080fd5b6109768261089e565b6000602082840312156109aa57600080fd5b61097682610875565b600084516109c58184602089016108e9565b80830190507f2e000000000000000000000000000000000000000000000000000000000000008082528551610a01816001850160208a016108e9565b60019201918201528351610a1c8160028401602088016108e9565b0160020195945050505050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b60007fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8203610a8957610a89610a29565b5060010190565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b600082610ace57610ace610a90565b500490565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b600082821015610b1457610b14610a29565b500390565b600082610b2857610b28610a90565b500690565b60008219821115610b4057610b40610a29565b500190565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fdfea164736f6c634300080f000a")
	L2ConfigOwnerKey           = common.HexToHash("0x0000000000000000000000000000000000000000000000000000000000000033")
	L2ConfigOwnerValue         = common.HexToHash("0x00000000000000000000000047d406f5faa74f8600870f8c0053d20aeb1f0d36")
	L2ConfigL1MinGasPriceKey   = common.HexToHash("0x0000000000000000000000000000000000000000000000000000000000000065")
	L2ConfigL1MinGasPriceValue = common.HexToHash("0x00000000000000000000000000000000000000000000000000000000B2D05E00") // 3 gwei
)

// ApplyL2Config modifies the state database according to the hard-fork rules
func ApplyL2Config(statedb *state.StateDB) {
	statedb.SetCode(L2ConfigProxy, L2ConfigProxyCode)
	statedb.SetState(L2ConfigProxy, L2ConfigProxyAdminKey, L2ConfigProxyAdminValue)
	statedb.SetState(L2ConfigProxy, L2ConfigProxyImplKey, L2ConfigProxyImplValue)
	statedb.SetState(L2ConfigProxy, L2ConfigProxyOwnerKey, L2ConfigProxyOwnerValue)
	statedb.SetState(L2ConfigProxy, L2ConfigProxyL1MinGasPriceKey, L2ConfigProxyL1MinGasPriceValue)

	statedb.SetCode(L2Config, L2ConfigCode)
	statedb.SetState(L2Config, L2ConfigOwnerKey, L2ConfigOwnerValue)
	statedb.SetState(L2Config, L2ConfigL1MinGasPriceKey, L2ConfigL1MinGasPriceValue)
}
